# NAME

Dog::Preprocessor - Dog template preprocessor plug-in for Yip.

# SYNOPSIS

    package YipConfig;
    use parent qw(Exporter);
    use Dog::Preprocessor;
    
    our @EXPORT = qw($config_dbpath);
    our @EXPORT_OK = qw(config_preprocessor);
    
    $config_dbpath = '/example/path/to/cms/db.sqlite';
    
    sub config_preprocessor { 
      ($#_ == 1) or die "Wrong number of parameters, stopped";
      my $tmpl = shift;
      my $vars = shift;
      Dog::Preprocessor->handle($tmpl, $vars);
    }
    
    1;

# DESCRIPTION

This module is a plug-in preprocessor for Yip that provides additional
processing needed to generate gallery pages.

In order for Dog to function correctly on Yip, this preprocessor must be
installed in the Yip deployment.  To do this, include a directory `Dog`
somewhere in the include path used for all CGI scripts of the Yip
deployment, and put this module `Preprocessor.pm` within that directory
named `Dog`.  The recommended method is to have the `Dog` directory
have the same parent directory as the `Yip` directory that holds the
Yip modules.

After that, define the `YipConfig.pm` module in the format given in the
synopsis, except change the value of `config_dbpath` to the proper path
to the SQLite database holding the Yip CMS.  This configuration file
will invoke this Dog preprocessor module through `config_preprocessor`.

See the documentation of the `handle` function in this module for
further details about what this preprocessor does.

# CLASS METHODS

- **handle(tmpl, vars)**

    This is the preprocessor function, which must be invoked as a class
    method of this module.

    `tmpl` is a string that names the specific template that preprocessing
    is being requested for.  This preprocessor function only does something
    if `tmpl` is equal to `post` and otherwise returns without doing any
    preprocessing.

    `vars` is a hash reference that contains all the template variables
    that are about to be used to run a template, in the structure expected
    by the `HTML::Template` module.  Note that all strings are binary
    encoded in UTF-8.

    When `tmpl` is equal to `post`, then this preprocessor will modify the
    passed hash reference.  First, it will verify that `_code` is defined
    as a scalar property (which is standard for post templates).  This
    variable holds the code that was generated from the template code for
    the post when running in the full profile.  For template code generated
    by the `dogpack.pl` script, this `_code` value should be a JSON
    description of the contents of the gallery.

    This JSON description is parsed by this preprocessor to get the gallery
    name, the gallery description, and a list of attachment indices to the
    photos in this gallery, using the largest resolution profile available
    for each photo.

    This preprocessor will then set a template variable named `gname` equal
    to the provided gallery name, and a template variable named `gdesc`
    equal to the provided gallery description.

    This preprocessor will also set a template variable named `photos`
    equal to a template array.  Each element of this template array has the
    properties `path_full` (the path to the largest-resolution version of
    the photo), `path_tiny` (the path to the Tiny resolution version of the
    photo) and `ati_full` (the attachment index of the largest-resolution
    version of the photo).

    If any of these new variables are already defined, they will be
    overwritten by this preprocessor.

    The additional template variables generated by this preprocessor are
    enough to allow the gallery template to be generated.

# AUTHOR

Noah Johnson, `noah.johnson@loupmail.com`

# COPYRIGHT AND LICENSE

Copyright (C) 2022 Multimedia Data Technology Inc.

MIT License:

Permission is hereby granted, free of charge, to any person obtaining a
copy of this software and associated documentation files
(the "Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
