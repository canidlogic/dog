# Dog URL handling

The Dog CMS engine supports a special URL syntax for dynamically generating URLs and embedding and generating textual content.  Dog URL processing is at heart a simple search-and-replace function.  Specifically, the following character sequence is searched for:

    [[dog://

Anywhere this sequence of eight _case sensitive_ characters occurs is processed by the Dog CMS URL resolver.  If you need to include this sequence of eight characters without it being processed, you can escape it as follows:

    [[dog://!

This causes the Dog CMS URL resolver to replace this sequence of nine characters with the first eight characters in the output (without the trailing `!` exclamation mark).

In all other cases, the `dog://` URL must be enclosed in double square brackets:

    [[dog://...]]

Within the enclosed `...`, neither the sequence `[[` nor the sequence `]]` may occur.

Since the search-and-replace functionality is low-level and has nothing to do with XML or HTML document structure, Dog URLs can be included and processed anywhere, even in places like JavaScript blocks, embedded CSS stylesheets, HTML comments, and XML processing instructions.  This also means that you have to be careful to escape literal `[[dog://` characters sequences _everywhere_ in the document.

The following subsections document what kind of special URLs are allowed in this `dog://` scheme.

## Dog catalog URLs

Dog URLs can be replaced by the URL to a specific page of the catalog using the following syntaxes:

    [[dog://catalog/{pagenum}]]
    [[dog://catalog]]

The second syntax is an abbreviation for `[[dog://catalog/1]]` which refers to the first page of the catalog.

`{pagenum}` is the number of the catalog page as an unsigned decimal integer, where 1 is the first page.  To use this URL syntax, a variable named `catalog_prefix` must be defined in the `vars` table in the Dog CMS database.  Optionally, there may also be a variable named `catalog_first` defined in the `vars` table.  For any catalog page except the first, the URL to the catalog page is generated by taking the value of the `catalog_prefix` variable and suffixing `{pagenum}` as an unsigned decimal integer with no leading zeroes.  For the first catalog page, the same method is used _except_ when `catalog_first` is defined, in which case the value of `catalog_first` is used.

For example:

    catalog_first  = /mysite/
    catalog_prefix = /mysite/index.cgi?page=

    Dog URL #1:
    <a href="[[dog://catalog/32]]">

    Dog URL #1 resolution:
    <a href="/mysite/index.cgi?page=32">

    Dog URL #2:
    <a href="[[dog://catalog]]">

    Dog URL #2 resolution:
    <a href="/mysite/">

## Dog resource URLs

Dog URLs can be replaced by the URL to a specific global or local resource by using one of the following syntaxes:

    [[dog://site/{resname}]]
    [[dog://page/{pageid}/{resname}]]
    [[dog://here/{resname}]]

In order to use Dog resource URLs, a variable named `resource_prefix` must be defined in the `vars` table in the Dog CMS database.

The first syntax is used for global resources.  These are resources that are not attached to any specific page.  `{resname}` is the name of the global resource.  Within the Dog CMS database, the most recent version of the named global resource is looked up to read its unique resource code.  The Dog resource URL is then replaced with the value of the `resource_prefix` variable, with the unique resource code appended to it.  For example:

    resource_prefix = "/cgi-bin/resource.cgi?code="
    
    Dog URL example:
    <img src="[[dog://site/my_logo]]"/>

    Resource table:

     rpage |  rname  |   rtime    |         rcode
    =======+=========+============+========================
     NULL  | my_logo | 1643146075 | R5mKwsDukZ0y7KhyG5-yQg
     NULL  | my_logo | 1640554126 | 9IvxXyJwivb0ekde8GCeKA
     NULL  | my_logo | 1637962146 | GaeftNe_dCGgWWkRgTovKg

    Resolution:
    <img src="/cgi-bin/resource.cgi?code=R5mKwsDukZ0y7KhyG5-yQg"/>

The second syntax is used to select a resource that is attached to a specific page.  `{pageid}` is the name of the page and `{resname}` is the name of the resource that is attached to that page.  Within the Dog CMS database, the page within the given ID is located.  Then, all records in the resource table that reference that page _and_ have the given `{resname}` are selected.  If there are multiple such records, the one with the most recent timestamp is used.  The unique resource code is determined from this selected record and returned to the client, prefixed with the value of the `resource_prefix` variable.  For example:

    resource_prefix = "/resource/"
    
    Dog URL example:
    <img src="[[dog://page/my_page/my_photo]]"/>

    Page table:

     pid |  pname
    =====+=========
      25 | my_page

    Resource table:

     rpage |  rname   |   rtime    |         rcode
    =======+==========+============+========================
        25 | my_photo | 1643146075 | ozPiNGtWQgVqJeN54Z00vQ
        25 | my_photo | 1640554126 | XL2bclrvF7mhOuY3F0yuRQ
        25 | my_photo | 1637962146 | g5pDsacgBbTMJvPkpeuUDQ

    Resolution:
    <img src="/resource/ozPiNGtWQgVqJeN54Z00vQ"/>

The third syntax is a context-sensitive way of referring to resources that are attached to a specific page without having to explicitly include the page ID of the current page.  Whenever Dog URLs are processed, there is a "current page" setting that either contains the page ID of the current page in the context, or is empty meaning that no current page is in the context.  When generating a specific page, the "current page" is always the page ID of the specific page that is being generated.  When generating a listing for a specific page within a catalog page, the "current page" is always the page ID of the specific page whose entry is being generated.  When generating a full catalog page without reference to any specific page, the "current page" is empty.

The third syntax may only be used when the "current page" is not empty.  The `here` part of the Dog URL is replaced with `page/{pageid}` where `{pageid}` is the page ID value stored in the "current page" context setting.  Then, the replaced Dog URL is processed the same way as for the second syntax explained above.

## Dog page URLs

Dog URLs can be replaced by the URL to a specific page by using one of the following syntaxes:

    [[dog://page/{pageid}]]
    [[dog://here]]

The first syntax is used to get the URL to a page with ID `{pageid}`.  It works by looking up the page record with that ID in the page table in the Dog CMS database.  The page URL field is taken from this record.  Then, if a variable named `page_prefix` is defined in the `vars` table, its value is prefixed to the page URL value to form the replacement URL; otherwise, the replacement URL is the same as the page URL field value.  For example:

    page_prefix = "/~username/view/"

    Dog URL example:
    <a href="[[dog://page/my_page]]"/>

    Page table:

     pid |  pname  |      purl
    =====+=========+================
      25 | my_page | page-url-title

    Resolution:
    <a href="/~username/view/page-url-title"/>

The second syntax makes use of the concept of a "current page" setting in the context (see the previous section for details).  The second syntax may only be used when the "current page" setting in the context is not empty.  The `here` part of the URL is replaced with `page/{pageid}` where `{pageid}` is the ID of the page that is the "current page" in the context.  The Dog URL is then processed the same way as for the first syntax explained above.  This is especially useful for generating a link to the page URL from a catalog page listing entry, since the "current page" for the page listing will be set to the correct page.

## Dog text embedding

Dog URLs can also be replaced by literal text from the `embed` table by using one of the following syntaxes:

    [[dog://embed/site/{embedname}]]
    [[dog://embed/page/{pageid}/{embedname}]]
    [[dog://embed/here/{embedname}]]

The first syntax is used for global embeds.  These refer to records in the `embed` table that are not associated with any specific page.  The `{embedname}` is the name of the specific embed record, which must be unique within the set of all global embeds.

The second syntax is used for embeds specific to the page with ID `{pageid}`.  The `{embedname}` for this syntax must only be unique within the set of all embeds for that specific page.

The third syntax makes use of the concept of a "current page" setting in the context (see the previous sections for details).  This syntax may only be used when the "current page" setting in the context is not empty.  The `here` part of the URL is replaced with `page/{pageid}` where `{pageid}` is the ID of the page that is the "current page" in the context.

The previous kinds of Dog URLs were replaced with a URL reference that is included in the final text.  However, this syntax instead generates text and replaces the Dog URL with the generated text, thereby embedding the content directly in the page instead of linking to it.

Records within the `embed` table can choose what kind of processing is applied to the text before it is embedded.  There can be no processing (in which case the text is just echoed in place of the Dog URL), or recursive Dog URL processing, or template processing, or both template and recursive Dog URL processing.  When both template and recursive Dog URL processing are selected at the same time, template processing is always done first, and then recursive Dog URL processing.

Dog URL processing is actually always done.  When a text record in the `embed` table specifies that there should be no Dog URL processing, then what actually happens is that any character sequences `[[dog://` found in the text are escaped as `[[dog://!` so that the result of applying Dog URL processing will be exactly the same as if there was no Dog URL processing.

Recursive Dog URL processing means that before the original Dog URL is replaced, Dog URLs in the generated output are themselves processed and replaced.  This can allow for multi-level recursive text processing.  To prevent infinite loops, the Dog CMS text engine keeps track of a stack of embed records and makes sure when a new embed is recursively processed, that it does not already exist on the embed record stack.  This prevents infinite loops within the recursion.

To prevent excessive processing, the maximum depth of recursive Dog URL resolution is also limited.  By default, this limit is 32 levels of recursion.  However, if the configuration variable `recurse_limit` is defined in the `vars` table, then the integer value there (which must be greater than zero) is used instead as the limit.

Template processing works according to the `HTML::Template` Perl module.  See `PageTemplate.md` for further details about templates.
