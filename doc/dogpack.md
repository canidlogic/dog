# NAME

dogpack.pl - Create a Yip MIME message that encodes a Dog-format photo
album.

# SYNOPSIS

    ./dogpack.pl < album.json > album.msg
    ./dogpack.pl test large example.png -90

# DESCRIPTION

Reads a JSON description of a photo album from input, and generates a
MIME message on output that can be directly imported into the Yip CMS.

**Warning:** The whole encoded MIME message will have to be stored in
memory, so this is _not_ intended for large photo galleries, or you
will likely run out of memory!

If invoked with the `test` syntax shown in the synopsis, this script
will instead generate a single transcoded and rotated image for
diagnostic purposes.  (Especially useful for making sure the rotation is
correct!)  The alternate syntax must begin with the `test` parameter,
then a parameter selecting the resolution profile (`tiny` `small`
`medium` or `large`), then the path to the original photo file, and
finally the rotation in clockwise degrees (0, 90, 180, 270, -90, -180,
or -270).  The test syntax will write the transcoded JPEG file to
standard output.  If the requested resolution profile is not available
for this specific photo, the largest available resolution profile is
output instead.

## Input format

The input file passed to this script must be in JSON format.  The
specific structure of the JSON required by this script is described in
this section.

An example input JSON looks like this:

    {
      "uid": 913055,
      "gdate": "2022-05-20T10:16:53",
      "gname": "Example photo gallery",
      "gdesc": "An example photo gallery.",
      "photos": [
        ["photo_1.jpg", 0],
        ["another_example.png", 0],
        ["interesting_dog.jpg", -90]
      ]
    }

The `uid` property is the unique ID that will be given to the Yip post.
It must be in range \[100000, 999999\].  The `gdate` property is the
timestamp given to the Yip post.  It must be in `yyyy-mm-ddThh:mm:ss`
format with zero-padding to make each field a constant length.

The `gname` property gives the name of the photo gallery and the
`gdesc` property gives a textual description.  Both strings are allowed
to contain Unicode, as well as less-than sign, greater-sign, and
ampersand, but they may not contain any control characters in range
\[0, 0x1f\] or 0x7f.  Note that less-than sign, greater-sign, and
ampersand will automatically be escaped for HTML, so you can not include
any markup or entity references within this data.

The `photos` property must map to an array or zero or more photo
subarrays.  Each photo subarray has exactly two elements, a string
giving the path to the original photo file, and an integer indicating
what rotation (clockwise, in degrees) to apply to the photo before
storing it.  Rotation may only have the values 0, 90, 180, 270, -90,
\-180, and -270.

The photo files do _not_ need to be in JPEG, although this script will
automatically transcode all the packed images into JPEG.  Note that the
input photos should not use any transparency, since JPEG doesn't support
transparency.  Any of the image formats that the `Imager` module can
detect are acceptable.

## Output format

The basic output format is a MIME message generated by the `Yip::Post`
module of the Yip CMS.  However, this MIME message has additional
structuring conventions beyond those specified by Yip, which are
described in the following subsections.

### Attachment conventions

Dog has a special convention for attachment indices within the generated
post.  The first digit of the attachment index selects the resolution of
the image, which is in four different classes.  Digits 1 and 2 select
_Tiny_ class, digits 3 and 4 select _Small_ class, digits 5 and 6
select _Medium_ class, and digits 7 and 8 select _Large_ class.

The following table shows the first digit of the attachment index in the
first column, the class name in the second column, the standard basis
for this resolution class in the third column, and the number of pixels
of this resolution in the fourth column.  The number of pixels is always
equal to the width multiplied by the height from the third column.  The
specific aspect ratio of width to height given in the third column is
completely relevant; only the total number of pixels given in the fourth
column is meaningful.  For all rows except the first, the fifth column
is the the number of pixels in the current row divided by the number of
pixels from the previous row (approximately).

     Index |  Class |        Basis        | Pixels  | Increase
    =======+========+=====================+=========+==========
      1-2  | Tiny   |  320 x  240 : QVGA  |   76800 |    -
      3-4  | Small  |  640 x  480 : VGA   |  307200 |   4.0x
      5-6  | Medium | 1024 x  768 : XGA   |  786432 |   2.6x
      7-8  | Large  | 1920 x 1080 : 1080P | 2073600 |   2.6x

Each class therefore has two different digits associated with it.  Call
the lower digit of each class the _lesser class digit_ and the upper
digit of each class the _greater class digit_.

While the first digit of the attachment index indicates the resolution
class as shown in the above table, the last three digits of the
attachment index select a specific photo from the gallery.  The photo
number can be in range \[0, 1999\], allowing for 2000 photos in the
gallery.  For photo numbers \[0, 999\], the lesser class digit is used as
the first digit of the attachment index and the last three digits of the
attachment index are equal to the photo number.  For photo numbers in
range \[1000, 1999\], the greater class digit is used as the first digit
of the attachment index and the last three digits of the attachment
index are equal to the photo number subtracted by 1000.

_Warning:_ Although this scheme allows for up to 2000 photos in a
single gallery, all photos will be packed in up to four versions each in
the generated MIME message.  A gallery of 2000 photos will in all
likelihood result in a generated MIME message that is so large it can't
be uploaded to Yip in any practical way.  In practice, it's a good idea
to stay very far below the limit of 2000 photos, splitting large
collections of photos into multiple galleries to keep the generated MIME
size practical.

Every photo in the gallery will have a Tiny-class attachment version.
Depending on the size of the photo, it may have additional resolution
class versions available.  All versions of the same photo will have the
same photo number and differ only by the first digit.  For example,
photo number 23 might have versions 1023 (Tiny), 3023 (Small), 5023
(Medium), and 7023 (Large).  Photo number 1509 might have versions
2509 (Tiny), 4509 (Small), 6509 (Medium), and 8509 (Large).

Let `w` be the width in pixels of the original photo and `h` be its
height in pixels.  Then, let `p` be `w` multiplied by `h`, which is
the total number of pixels in the original photo.  If `p` is less than
or equal to 2073600, then let `mw` and `mh` equal `w` and `h`.
Otherwise, Let `ms` be the square root of the result of 2073600 divided
by `p`, and then let `mw` and `mh` be `w` and `h` multiplied by
`ms`, floored down to an integer value, and then increased if necessary
to be at least one.

The `mw` and `mh` values computed in the previous step are the
dimensions of the largest-resolution version of the photo that will be
stored in the gallery.  Either `mw` and `mh` are exactly equal to the
original dimensions, or they reduce the original photo to not exceed the
limit of 2073600 pixels, while maintaining the aspect ratio.

Let `mp` be the result of multiplying `mw` and `mh`, which is the
total number of pixels in the largest-resolution version that will be
stored in the gallery.  If `mp` is greater than 786432, then the
largest-resolution version is the Large resolution class.  Else, if
`mp` is in range \[307201, 786432\], then the largest-resolution version
is the Medium resolution class.  Else, if `mp` is in range \[76801,
307200\], then the largest-resolution version is the Small resolution
class.  Else, if `mp` is in range \[1, 76800\], then the
largest-resolution version is the Tiny resolution class.

If a particular photo has a certain resolution class, then it must also
have all lesser resolution classes.  Therefore, by knowing the
resolution class of the largest version of the photo, one also knows all
of the resolution classes that will be generated for that particular
photo.  The exact resolution of the largest resolution class for a photo
was already computed with the `mw` and `mh` variables defined earlier.
To compute the exact resolution of another resolution class, let `pt`
be the number of pixels for that resolution class given in the table
earlier in this section.  Once again letting `p` be the total number of
pixels in the original photo, let `sc` be the square root of the result
of `pt` divided by `p`, and then let `rw` and `rh` be the `w` and
`h` of the original photo multiplied by `sc`, floored down to an
integer value, and then increased if necessary to be at least one.

All photos included in the packed MIME message will be re-encoded by
this script using the `Imager` module with a JPEG quality of 90, to
ensure consistent encoding.  (In other words, the original photo file
is never directly included in the packed MIME message.)  The `Imager`
JPEG encoder claims that it will not write any EXIF metadata.  Input
photos do not need to be JPEG, but note that since JPEG doesn't support
transparency, none of the input photos should use transparency or else
they will be flattened by the `Imager` JPEG encoder by compositing
transparent pixels against a black background.

The Yip data type of all attached photos will be set to `jpeg`.

### Body conventions

The body of the Yip MIME messages generated by this script has a
standard format described in this subsection.

An example of a standard body looks like this:

    <TMPL_IF NAME=_partial>
    <div class="galleryname">Example photo gallery</div>
    <div class="gallerydesc">An example photo gallery.</div>
    </TMPL_IF>
    
    <TMPL_IF NAME=_full>
    <script id="galleryjson" type="application/json">
    {
      "gname": "Example photo gallery",
      "gdesc": "An example photo gallery.",
      "photos": [
        7000,
        7001,
        1002,
        3003,
        7004,
        5005
      ]
    }
    </script>
    </TMPL_IF>

This body has two completely separate renderings when in partial mode
(used within catalog and archive listing) and in full mode (used for the
actual gallery page).  In partial mode, the body merely gives the name
and description of the gallery that were given in the input JSON to this
script, putting each in its own DIV with its own DIV class for styling
purposes, as shown in the example above.

In full mode, the body adds a data-bearing script element containing
JSON describing the gallery.  The JSON is an object with `gdesc` and
`gname` properties storing the description and name of the gallery once
again, and then a `photos` properties which maps to an array of
integers.  Each integer is attachment index of a photo in the gallery,
and the indices are sorted in ascending order of photo number.  Where a
specific photo number has multiple versions in various resolution
classes, the largest resolution class available is given.

Within the `gdesc` and `gname` property values, the less-than and
greater-than angle brackets as well as the ampersand will be escaped
using JSON numeric codepoint escapes.  When the JSON is parsed in
JavaScript, these escapes will transparently map back to the original
characters.  For the DIVs used in the partial rendering, the angle
brackets and ampersand will be escaped using HTML named entities.

# AUTHOR

Noah Johnson, `noah.johnson@loupmail.com`

# COPYRIGHT AND LICENSE

Copyright (C) 2022 Multimedia Data Technology Inc.

MIT License:

Permission is hereby granted, free of charge, to any person obtaining a
copy of this software and associated documentation files
(the "Software"), to deal in the Software without restriction, including
without limitation the rights to use, copy, modify, merge, publish,
distribute, sublicense, and/or sell copies of the Software, and to
permit persons to whom the Software is furnished to do so, subject to
the following conditions:

The above copyright notice and this permission notice shall be included
in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT.
IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY
CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT,
TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE
SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
